name: Deploy Production (2-Phase)

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'IAs-Loto/**'
      - 'ias/**'
      - '*.md'
      - 'README.md'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 212.227.230.103
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== INICIO: DESPLIEGUE AT√ìMICO (v2) ==="

            # 1. Navegar al directorio del proyecto
            cd /var/www/tienda-web-lotoAI-1 || exit 1

            # (Mantenemos la l√≥gica de backup y restauraci√≥n de archivos)
            echo "--- Fase 1.5: Respaldando archivos de configuraci√≥n ---"
            if [ -f ".env" ]; then cp .env .env.backup; fi
            if [ -f ".env.production" ]; then cp .env.production .env.production.backup; fi
            if [ -f "src/assets/botes.json" ]; then cp src/assets/botes.json src/assets/botes.json.backup; fi
            if [ -f "src/assets/lottery-data.json" ]; then cp src/assets/lottery-data.json src/assets/lottery-data.json.backup; fi
            echo "‚úÖ Backups de configuraci√≥n creados."

            # 2. Actualizar desde GitHub
            echo "--- Fase 2: Actualizando c√≥digo fuente ---"
            git fetch origin main
            git reset --hard origin/main
            git pull origin main

            # 2.5. Restaurar archivos de configuraci√≥n
            echo "--- Fase 2.5: Restaurando archivos de configuraci√≥n ---"
            if [ -f ".env.backup" ]; then mv .env.backup .env; fi
            if [ -f ".env.production.backup" ]; then mv .env.production.backup .env.production; fi
            if [ -f "src/assets/botes.json.backup" ]; then mv src/assets/botes.json.backup src/assets/botes.json; fi
            if [ -f "src/assets/lottery-data.json.backup" ]; then mv src/assets/lottery-data.json.backup src/assets/lottery-data.json; fi
            echo "‚úÖ Archivos de configuraci√≥n restaurados."

            # 4. Instalar dependencias
            echo "--- Fase 4: Instalando dependencias ---"
            npm install --production=false

            # 6. Compilar el Backend
            echo "--- Fase 6: Compilando Backend ---"
            cd src/backend
            npm install && npm run build
            cd /var/www/tienda-web-lotoAI-1
            if [ ! -f "src/backend/dist/index.js" ]; then
              echo "‚ùå Error de compilaci√≥n en el Backend. Abortando."
              exit 1
            fi
            echo "‚úÖ Backend compilado."

            # 7. Compilar el Frontend en un directorio temporal
            echo "--- Fase 7: Compilando Frontend (Build At√≥mico) ---"
            sudo fallocate -l 2G /swapfile || true
            sudo chmod 600 /swapfile || true
            sudo mkswap /swapfile || true
            sudo swapon /swapfile || true
            
            NODE_OPTIONS="--max-old-space-size=4096" npx ng build --configuration=production --output-path=dist_new
            if [ $? -ne 0 ]; then
              echo "‚ùå Error de compilaci√≥n en el Frontend. Abortando."
              sudo swapoff /swapfile && sudo rm /swapfile
              exit 1
            fi
            echo "‚úÖ Frontend compilado en 'dist_new'."
            
            sudo swapoff /swapfile && sudo rm /swapfile

            # 8. Reemplazo At√≥mico y Reinicio de PM2 (M√©todo Robusto)
            echo "--- Fase 8: Reemplazo At√≥mico y Reinicio de Servicios ---"
            
            # El reemplazo at√≥mico: se hace ANTES de tocar PM2
            rm -rf dist_old && echo "üßπ Limpiado backup antiguo."
            if [ -d "dist" ]; then
              mv dist dist_old
              echo "‚úÖ Directorio 'dist' actual renombrado a 'dist_old'."
            fi
            mv dist_new dist
            echo "‚úÖ Nuevo build 'dist_new' renombrado a 'dist'."
            
            # Ahora, reiniciar PM2 de forma agresiva como en el script original
            echo "--- Limpiando y reiniciando servicios con PM2 ---"
            pm2 stop all || echo "No hab√≠a procesos corriendo."
            pm2 delete all || echo "No hab√≠a procesos para eliminar."
            pm2 save --force
            
            # Liberar puertos por si acaso
            fuser -k 3000/tcp 2>/dev/null || true
            fuser -k 4000/tcp 2>/dev/null || true
            fuser -k 5000/tcp 2>/dev/null || true
            sleep 2
            
            # Iniciar de nuevo desde el ecosystem file (el m√©todo correcto)
            echo "--- Iniciando servicios con la nueva configuraci√≥n ---"
            pm2 start ecosystem.config.js --env production
            pm2 save
            
            # Limpiar el directorio antiguo en segundo plano
            rm -rf dist_old &

            # 8.5. Verificaci√≥n Post-Reinicio
            echo "--- Fase 8.5: Verificando estado de PM2 ---"
            sleep 8
            pm2 status
            netstat -tuln | grep -E ':3000|:4000|:5000'
            
            # 9. Actualizar y recargar NGINX
            echo "--- Fase 9: Actualizando configuraci√≥n de NGINX ---"
            cp nginx.conf /etc/nginx/sites-available/loto-ia.com
            ln -sf /etc/nginx/sites-available/loto-ia.com /etc/nginx/sites-enabled/
            nginx -t
            if [ $? -eq 0 ]; then
              systemctl reload nginx
              echo "‚úÖ NGINX recargado."
            else
              echo "‚ùå Error de sintaxis en nginx.conf."
              exit 1
            fi

            echo "‚úÖ FIN: DESPLIEGUE AT√ìMICO (v2) COMPLETADO CON √âXITO"

      - name: Deployment success notification
        if: success()
        run: |
          echo "::notice::Deployment completed successfully! The application has been deployed to the VPS."

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "::error::Deployment failed! Please check the logs for more information."
