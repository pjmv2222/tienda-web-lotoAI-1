name: Deploy Production (2-Phase)

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'IAs-Loto/**'
      - 'ias/**'
      - '*.md'
      - 'README.md'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 212.227.230.103
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== INICIO: DESPLIEGUE AT√ìMICO (v4 - Final) ==="

            cd /var/www/tienda-web-lotoAI-1 || exit 1

            echo "--- Fase 1: Actualizando c√≥digo fuente ---"
            git fetch origin main
            git reset --hard origin/main
            git pull origin main

            echo "--- Fase 2: Instalando dependencias ---"
            npm install --production=false

            echo "--- Fase 3: Compilando Backend ---"
            cd src/backend
            npm install && npm run build
            cd /var/www/tienda-web-lotoAI-1
            if [ ! -f "src/backend/dist/index.js" ]; then
              echo "‚ùå Error de compilaci√≥n en el Backend. Abortando."
              exit 1
            fi
            echo "‚úÖ Backend compilado."

            echo "--- Fase 4: Compilando Frontend en directorio temporal ---"
            sudo fallocate -l 2G /swapfile || true
            sudo chmod 600 /swapfile || true
            sudo mkswap /swapfile || true
            sudo swapon /swapfile || true
            
            NODE_OPTIONS="--max-old-space-size=4096" npx ng build --configuration=production --output-path=dist_new
            if [ $? -ne 0 ]; then
              echo "‚ùå Error de compilaci√≥n en el Frontend. Abortando."
              sudo swapoff /swapfile && sudo rm /swapfile
              exit 1
            fi
            echo "‚úÖ Frontend compilado en 'dist_new'."
            
            sudo swapoff /swapfile && sudo rm /swapfile

            echo "--- Fase 5: Reemplazo At√≥mico y Reinicio de PM2 ---"
            
            # Reemplazo at√≥mico
            rm -rf dist_old && echo "üßπ Limpiado backup antiguo."
            if [ -d "dist" ]; then
              mv dist dist_old
            fi
            mv dist_new dist
            echo "‚úÖ Directorio de build reemplazado at√≥micamente."
            
            # Reinicio robusto de PM2
            pm2 stop all || true
            pm2 delete all || true
            pm2 save --force
            
            echo "--- Iniciando todos los servicios ---"
            pm2 start ecosystem.config.js --env production
            pm2 save
            
            # Limpiar el directorio antiguo en segundo plano
            rm -rf dist_old &

            echo "--- Fase 6: Verificaci√≥n Post-Despliegue ---"
            sleep 8
            pm2 status
            netstat -tuln | grep -E ':3000|:4000|:5000'
            
            echo "--- Fase 7: Actualizando NGINX ---"
            cp nginx.conf /etc/nginx/sites-available/loto-ia.com
            ln -sf /etc/nginx/sites-available/loto-ia.com /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx

            echo "‚úÖ FIN: DESPLIEGUE COMPLETADO CON √âXITO."

      - name: Deployment success notification
        if: success()
        run: |
          echo "::notice::Deployment completed successfully! The application has been deployed to the VPS."

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "::error::Deployment failed! Please check the logs for more information."
